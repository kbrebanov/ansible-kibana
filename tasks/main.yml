---
# tasks file for kibana

- name: Include distribution specific variables
  include_vars: "{{ ansible_distribution }}.yml"
  tags:
    - kibana

- include: CentOS.yml
  when: ansible_distribution == "CentOS"
  tags:
    - kibana

- include: Ubuntu.yml
  when: ansible_distribution == "Ubuntu"
  tags:
    - kibana

- name: Download Kibana
  become: yes
  get_url:
    url: "{{ kibana_url }}"
    dest: "{{ kibana_download_dir }}/kibana.tar.gz"
    sha256sum: "{{ kibana_sha256sum }}"
  tags:
    - kibana

- name: Create Kibana installation directory
  become: yes
  file:
     path: "{{ kibana_install_dir }}"
     owner: root
     group: root
     mode: 0755
     state: directory
  tags:
    - kibana

- name: Unarchive Kibana to installation directory
  become: yes
  unarchive:
    src: "{{ kibana_download_dir }}/kibana.tar.gz"
    dest: "{{ kibana_install_dir }}"
    owner: root
    group: root
    mode: 0755
    copy: no
    creates: "{{ kibana_install_dir }}/kibana-{{ kibana_version }}-linux-x64"
  tags:
    - kibana

- name: Create symlink for current version
  become: yes
  file:
    src: "{{ kibana_install_dir }}/kibana-{{ kibana_version }}-linux-x64"
    dest: "{{ kibana_install_dir }}/current"
    state: link
  tags:
    - kibana

- name: Create Kibana configuration file
  become: yes
  template:
    src: kibana.yml.j2
    dest: "{{ kibana_install_dir }}/current/config/kibana.yml"
    owner: root
    group: root
    mode: 0755
  tags:
    - kibana
