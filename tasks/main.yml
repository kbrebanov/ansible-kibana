---
# tasks file for kibana

- name: Include distribution specific variables
  include_vars: "{{ ansible_distribution }}.yml"
  tags: kibana

- include: CentOS.yml
  when: ansible_distribution == "CentOS"
  tags: kibana

- include: Ubuntu.yml
  when: ansible_distribution == "Ubuntu"
  tags: kibana

- name: Download Kibana
  get_url: >
    url={{ kibana_url }}
    dest={{ kibana_download_dir }}/kibana.tar.gz
    sha256sum={{ kibana_sha256sum }}
  tags: kibana

- name: Create Kibana installation directory
  file: >
     path={{ kibana_install_dir }}
     owner={{ kibana_install_dir_owner }}
     group={{ kibana_install_dir_group }}
     mode={{ kibana_install_dir_mode }}
     state=directory
  tags: kibana

- name: Unarchive Kibana to installation directory
  unarchive: >
    src={{ kibana_download_dir }}/kibana.tar.gz
    dest={{ kibana_install_dir }}
    owner={{ kibana_install_dir_owner }}
    group={{ kibana_install_dir_group }}
    mode={{ kibana_install_dir_mode }}
    copy=no
    creates={{ kibana_install_dir }}/kibana-{{ kibana_version }}-linux-x64
  tags: kibana

- name: Create symlink for current version
  file: >
    src={{ kibana_install_dir }}/kibana-{{ kibana_version }}-linux-x64
    dest={{ kibana_install_dir }}/current
    state=link
  tags: kibana

- name: Create Kibana configuration file
  template: >
    src=kibana.yml.j2
    dest={{ kibana_install_dir }}/current/config/kibana.yml
    owner={{ kibana_install_dir_owner }}
    group={{ kibana_install_dir_group }}
    mode={{ kibana_install_dir_mode }}
  tags: kibana
